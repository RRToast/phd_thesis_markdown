<!-- Falls ich mehr schreiben möchte hier wäre ein gute Ort dafür -->
<!-- SCHRECK: (welches Konzept steckt dahinter, jeder Key hat einen Attestation Key, Protocol beschreibung, rekeying ) -->
<!-- was ich verstanden habe:
- jedes Keypair hat einen Attestation Key
- Account kann rekeyed werden, ob er das meinte weiß ich nicht
-->
# Theoretische Umsetzung \label{theoretisch}
Da nun die Grundlagen des ACME-Protokolls besprochen wurden, soll nun eine neue Challenge mit all den Änderungen, die diese mit sich bringt, besprochen werden, bevor im nächsten Kapitel deren praktische Umsetzung diskutiert wird. Zunächst soll beschrieben werden, welche Vorbereitungen getroffen werden müssen sowie welche Abläufe gleich bleiben und welche sich verändern sollen. Anschließend wird kurz dargestellt, welche zusätzlichen Schritte unternommen werden sollen, um dem Ziel, das Endbenutzersystem eindeutig identifizieren zu können, zu erreichen. Auch wie der Vorgang server- und clientseitig sicherer gestaltet werden kann, wird kurz besprochen.

## Aufbau der neuen ACME-Challenge
Wie im Grundlagenkapitel beschrieben, ist die Challenge das Herzstück des ACME-Protokolls. Ein Ziel dieser Bachelorarbeit besteht darin, eine neue Challenge zu erstellen. Dabei sollen die gleichen Sicherheitsstandards wie bei jeder anderen ACME-Kommunikation gelten. Um das zu erreichen, werden auch hier POST- und POST-as-GET-Requests verwendet. Mit ihnen in Verbindung mit JWS muss der Client in jeder Anfrage seine Nachrichten mit seinem Account Key signieren. Dadurch kann bei jeder Kommunikation genau bestimmt werden, um welchen Client es sich handelt. Auch Replay-Noncen sollen wieder eingesetzt werden. Sie sollen in jeder Kommunikation des Servers mit dem Client, die über das Anfragen eines Directorys hinausgehen, mitgeschickt werden. Alleine durch diese Maßnahme kann Gefahrenquellen wie Replay-Angriffen entgegengewirkt werden. Der im Grundlagenkapitel beschriebene Aufbau, in dem erst ein Konto erstellt, dann eine Challenge erzeugt, diese dann beantwortet und dann das Zertifikat mithilfe eines CSR erzeugt wird, bleibt also erhalten. Die neue Challenge soll dabei nicht die Kontrolle über eine Webseite oder einen DNS prüfen, sondern ein Endbenutzersystem eindeutig identifizieren können.

### Vorbereitung
Im Gegensatz zu den beiden oben besprochenen Challenge-Arten soll die neue Challenge die Kontrolle über das Gerät, für das sich der Client ausgibt, überprüfen. Der erste Schritt besteht darin, entweder vom Hersteller oder per Hand den öffentlichen Schlüssel des "Endorsement Key" (EK) aus dem TPM-Chip zu erhalten. Der sogenannte EK ist ein fester Bestandteil des TPM-Chips und wird bei dessen Erstellung vom Hersteller mit eingebaut. Der private Teil kann dabei von außen weder ausgelesen noch angefragt werden. Diese Tatsache wird verwendet, um das Gerät eindeutig zu identifizieren. Der öffentliche Teil des EK wird serverseitig gespeichert. Da der EK schon früh in der Kommunikation zwischen Server und Client mitgeschickt werden soll, kann der Server abgleichen, ob eine Anfrage tatsächlich von einem Gerät kommt, das auf dem Server registriert ist, und die Kommunikation frühzeitig beenden, falls das nicht der Fall ist.

### Konto erstellen und verwalten
Das im Grundlagenkapitel beschriebene Anfragen des Directorys sowie die Verwendung von Replay-Noncen oder das Erstellen des Kontos haben sich weder client- noch serverseitig geändert. Die einzige Änderung, die vorgenommen werden kann, jedoch optional für den weiteren Ablauf der neuen Challenge ist, ist das Erstellen des privaten und öffentlichen Schlüssels des Kontos durch den TPM-Chip. Jedes Konto wird durch seinen öffentlichen Schlüssel beim Server registriert. Dieses Schlüsselpaar wird unter anderem für die Kommunikation mit JWS, also das Signieren der Nachrichten verwendet. Da der TPM-Chip über eine kryptographische Einheit verfügt, kann sich der Client darauf verlassen, dass die so generierten Schlüssel sicher sind. Auf anderer Hardware ist das nicht so konsequent gewährleistet.

### Die EK-Challenge
Wie die DNS- und HTTP-Challenge besteht auch die neue EK-Challenge aus zwei Teilen, erst dem Absenden der Order, dann dem Erfüllen der Challenge.
Für die Challenge wird clientseitig mithilfe des TPM-Chips ein sogenannter AK erstellt. Der "Attestation Key" (AK), wie er hier verwendet wird, ist ein Container, der neben einem öffentlichen Schlüssel auch Metadaten, wie unter anderem die TPM-Version, besitzt. Der AK dient nicht nur als normaler Schlüssel, sondern vielmehr als eine Verpackung für Informationen über den TPM-Chip, Informationen die zum Erstellen eines Geheimnisses benötigt werden. Zusätzlich zu diesen Informationen, die der AK beinhaltet, ist es wichtig, diesen zu erstellen, da der EK alleine, abhängig von der TPM-Implementierung, eventuell nicht in der Lage ist, selbst zu verschlüsseln. Ziel dieser Verbindung aus EK und AK ist es, durch den EK das Gerät zu identifizieren und durch ein Geheimnis, das durch die Verwendung von EK und AK erstellt wird, zu verifizieren. Ein Geheimnis ist dabei nichts anderes als eine verschlüsselte Information, welche nur durch die enstprechenden privaten Schlüssel entschlüsselt werden kann. Das dabei verwendete Verfahren basiert auf einem Projekt von Google zur Identifizierung von Geräten [@go-attestation]. Durch dieses Verfahren kann auch der AK eindeutig dem Chip zugeordnet werden, es wird also auch sichergestellt, dass der AK vom gleichen Chip stammt wie der EK.

Für die Order werden nun AK sowie EK zusammen als Value für den Identifier bestimmt, der Type trägt nun den Namen der neuen Challenge "ek". Abgesehen von dieser Änderung wird die Anfrage regulär an den Server gesendet. Dieser kann nun überprüfen, ob der EK-Wert in seiner Datenbank vorkommt. Falls das nicht der Fall ist, wird dem Client ein HTTP-400-Fehler zurückgegeben, kommt der EK-Wert jedoch vor, kann nun mit der eigentlichen Challenge begonnen werden. Dazu erstellt der Server unter Verwendung der AK- und EK-Werte ein Geheimnis.

Der Client kann daraufhin mit einem POST-as-GET-Request dieses Geheimnis erfragen. Das Geheimnis kann nur mithilfe des TPM-Chips entschlüsselt werden, und die so entschlüsselte Nachricht wird wieder zurück an den Server gesendet. Wurde das Geheimnis korrekt entschlüsselt, gilt die Challenge als erfüllt und der Server ändert den Status der Challenge von "pending" über "processing" zu "valid". Durch das Erfüllen der Challenge wird sichergestellt, dass der Client die Kontrolle über den TPM-Chip besitzt. Die Prüfung der Identität des Client-Geräts ist eine Prüfung der Kontrolle über den entsprechenden TPM-Chip.

### CSR
Für die Erstellung des CSR verwendet der Client nun den TPM-Chip, zum einen da dieser über eine eingebaute kryptographische Funktion verfügt, zum anderen weil der private Schlüssel nie außerhalb des Chips existieren darf. Aus dem öffentlichen Schlüssel, zusammen mit anderen Daten, die im Zertifikat stehen sollen, erstellt der TPM-Chip eine CSR. Die CSR wird im Body der Nachricht an den Server gesendet, der das Zertifikat erstellt und dem Client zur Verfügung stellt, sodass dieser es per POST-as-GET-Request abfragen kann. Das so erhaltene Zertifikat wird nun auf dem TPM-Chip gespeichert. Der Schlüssel, der zur Erstellung des Zertifikates verwendet wurde, ist dabei der gleiche, der mit dem EK-AK-Verfahren überprüft wurde.

### Folgeanfragen
Der Client hat nun dem Server gegenüber bewiesen, dass er tatsächlich die Kontrolle über den TPM-Chip, den er angegeben hat, besitzt. Diese Information ist jedoch nur solange gültig, wie das Zertifikat gültig ist. Möchte der Client ein neues Zertifikat beantragen, so muss er einen neuen AK-Wert generieren, der den gleichen Prozess durchläuft wie der erste AK beim ersten Mal, als eine Order erstellt wurde. Er muss dem Server gegenüber noch einmal beweisen, dass er die Kontrolle über diesen Chip besitzt. Dieses Vorgehen wird so im RFC8555-Dokument festgehalten.
Zu diesem Verfahren gibt es eine Alternative, die auch kurz besprochen werden soll. Dabei wird zur Validierung des Clients beim Erstellen einer neuen Order das alte, aber noch gültige Zertifikat verknüpft, das den Client bereits validiert hat. Es handelt sich dabei um die Verkettung von Zertifikaten[@chain-of-trust]. Durch die Verknüpfung der Anfrage auf ein neues Zertifikat mit dem alten Zertifikat wird bewiesen, dass der Client die Kontrolle über den Chip immer noch besitzt. Auf die Vor- und Nachteile dieses Verfahrens im Vergleich zum hier gewählten wird in der Evaluation noch ausführlicher eingegangen.

## Zusätzliche Maßnahmen

### Clientseitig
Der Client verfügt also über die Möglichkeit, unter Verwendung des TPM-Chips ein Zertifikat vom spezifizierten ACME-Server zu erhalten. Das gesamte Verfahren wäre nutzlos, wenn es für einen Benutzer des Client-Geräts möglich wäre, wertvolle Informationen aus dem Ablauf des neuen ACME-Verfahrens abzufangen. Es muss also eine zusätzliche Sicherheit geschaffen werden, um das Client-Gerät vor seinen eigenen Nutzern zu schützen. Eine dementsprechende Maßnahme ist, dass der private Schlüssel, welcher zum Zertifikat gehört, den TPM nie verlässt. Aber auch Metadaten könnten für einen Angreifer interessant sein. Neben böswilligen kann es auch fahrlässige Nutzer geben, die schlicht vergessen, ein Zertifikat anzufragen oder zu erneuern, falls es veraltet. Aus all diesen Gründen wird ein "System Daemon" geschaffen, der die clientseitige Kommunikation mit dem ACME-Server übernimmt. Dabei soll geprüft werden, ob ein Zertifikat vorhanden ist. Falls nicht, wird ein neues erstellt. Ist ein Zertifikat vorhanden, aber veraltet oder läuft bald aus, so wird ein neues Zertifikat angefragt. Dadurch läuft die Kommunikation im Hintergrund ab und ist für den Nutzer des Gerätes unsichtbar. Zertifikate werden dem Nutzer nur durch den TPM-Chip zur Verfügung gestellt.

### Serverseitig
Der ACME-Server wird um die Funktionalität der Datenbankeinträge für öffentliche EK-Schlüssel erweitert, was für die Bearbeitung der neuen EK-Challenge notwendig ist. Durch eine Datenbank-API soll es einem Systemadministrator erleichtert werden, die Liste der bekannten öffentlichen EK-Schlüssel zu erweitern. Auch serverseitig gibt es Möglichkeiten, wie der Umgang mit EK-Werten sicherer gestaltet werden kann. So ist es möglich, sobald ein Client eine "ek"-Challenge gestellt und bestanden hat, dessen Konto mit dem entsprechendem EK-Wert in der Datenbank zu verknüpfen. So kann immer eindeutig identifiziert werden, wenn ein neues Zertifikat erstellt wird, für welchen TPM dieses gilt. Damit ist es auch einfacher, Zertifikate zu widerrufen, sollte das Gerät als gestohlen oder vermisst gemeldet werden, da nun diesem Datenbankeintrag, mit all seinen verknüpften Informationen, nicht mehr vertraut werden kann.
