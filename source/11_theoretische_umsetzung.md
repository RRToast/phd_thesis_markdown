<!-- Falls ich mehr schreiben möchte hier wäre ein gute Ort dafür -->
# Theoretische Umsetzung \label{theoretisch}
<!-- SCHRECK: (welches Konzept steckt dahinter, jeder Key hat einen Attestation Key, Protocol beschreibung, rekeying ) -->

<!-- was ich verstanden habe:
- jedes Keypair hat einen Attestation Key
- Account kann rekeyed werden, ob er das meinte weiß ich nicht
-->
## Aufbau der neuen ACME Challenge
Wie im Grundlagen Kapitel beschrieben, ist die Challenge das Herzstück des ACME Protokolls. Ein Ziel dieser Bachelorarbeit besteht darin, eine neue Challenge zu erstellen. Dabei sollen die gleichen sicherheitsstandards gelten, wie bei jeder anderen ACME Kommunikation. Um das zu erreichen werden auch hier POST und POST-as-GET Requests verwendet. Mit ihnen in Verbindung mit JWS muss der Client in jeder Anfrage seine Nachrichten mit seinem Account Key signieren. Dadurch kann bei jeder Kommunikation genau bestimmt werden um welchen Client es sich handelt. Auch Replay-Noncen sollen wieder eingesetzt werden, in jeder Kommunikation des Servers mit dem Client die über anfragen eines Directorys hinausgehen sollen sie mitgeschickt werden. Alleine durch diese Maßnahme können gefahrenquellen wie Replay-Angriffen entgegengewirkt werden. Der Im Grundlagenkapitel beschriebene Aufbau in dem erst ein Account erstellt wird, dann eine Challenge erzeugt, diese dann beantwortet und dann das Zertifikat mithilfe eines CSR erzeugt wird, bleibt also erhalten. Die neue Challenge soll dabei nicht die Kontrolle über eine Website oder einen DNS prüfen.

### Vorbereitung
Gegensätzlich zu den beiden besprochenen Challenge Arten soll die neue Challenge die Kontrolle, über das Gerät für welches sich der Client ausgibt, überprüfen. Der erste Schritt besteht darin entweder vom Hersteller oder per Hand den Public Key des *E*ndorsement *K*ey aus dem TPM Chip zu erhalten. Der sogenannte EK ist ein fester Bestandteil des TPM Chips und wird bei dessen Erstellung vom Hersteller mit eingebaut. Der Private Teil kann dabei von außen weder ausgelesen, noch angefragt werden. Diese Tatsache wird verwendet um das Gerät eindeutig zu identifizieren. Der Öffentliche Teil des EK wird Serverseitig gespeichert. Da der EK schon früh in der Kommunikation zwischen Server und Client mitgeschickt werden soll, kann der Server abgleichen ob eine Anfrage tatsächlich von einem Gerät kommt welches auf dem Server registriert ist und die Kommunikation frühzeitig beenden, falls das nicht der Fall ist.

### Account erstellen und verwalten
Das im Grundlagenkapitel beschrieben Anfragen des Directorys, sowie die Verwendung von Replay-Noncen oder das erstellen des Accounts haben sich weder Clientseitig noch Serverseitig geändert. Die einzige Änderung die vorgenommen werden kann, jedoch optional für den weiteren Ablauf der neuen Challenge ist, ist das erstellen des Privaten und Öffentlichen Schlüssels des Accounts durch den TPM Chip. Jeder Account wird durch seinen öffentlichen Schlüssel beim Server registriert. Dieses Schlüsselpaar wird unter anderem für die Kommunikation mit JWS, also dem signieren der Nachrichten verwendet. Da der TPM Chip über eine Kryptographische Einheit verfügt, kann sich der Client darauf verlassen, dass die so generierten Schlüssel sicher sind. Auf anderer Hardware ist das nicht so konsequent gewährleistet.

### Die EK Challenge
Wie auch bei der DNS und HTTP Challenge besteht auch die neue EK Challenge aus zwei Teilen, erst dem Absenden der Order, dann dem Erfüllen der Challenge.
Für die Challenge wird Clientseitig mithilfe des TPM Chips ein sogenannter AK erstellt. Der *A*ttestation *K*ey wie er hier verwendet wird, ist ein Container der neben einem öffentlichen Schlüssel auch Metadaten, wie die TPM Version neben einigen anderen, besitzt. Der AK dient nicht nur als normaler Schlüssel sondern vielmehr als eine Verpackung für Informationen über den TPM Chip, Informationen die zum erstellen des Geheimnisses benötigt werden. Zusätzlich zu diesen Informationen die der AK beinhaltet ist es wichtig diesen zu erstellen, da der EK alleine, abhängig von der TPM Implementierung, eventuell nicht in der Lage ist selbst zu Verschlüsseln. Ziel dieser Verbindung aus EK und AK ist es, durch den EK das Gerät zu Identifizieren und durch ein Geheimniss, dass durch die Verwendung von EK und AK erstellt wird zu verifizieren. Das dabei verwendete Verfahren basiert auf einem Projekt von Google zur identifizierung von Geräten [@go-attestation]. Durch dieses Verfahren wird kann auch der AK eindeutig dem Chip zugeordnet werden, es wird also auch sichergestellt, dass der AK vom gleichen Chip stammt wie der EK.

Für die Order werden nun AK sowie EK zusammen als Value für den Identifier bestimmt, der Type trägt nun den Namen der neuen Challenge "ek". Abgesehen von dieser Änderung wird die Anfrage regulär an den Server gesendet. Dieser kann nun überprüfen, ob der EK Wert in seiner Datenbank vorkommt. Falls nein wird dem Client ein 400 Fehler zurückgegeben, kommt der EK Value jedoch vor, kann nun mit der eigentlichen Challenge begonnen werden. Dazu erstellt der Server, unter Verwendung der AK und EK Werte ein Geheimnis.

Der Client kann daraufhin mit einem POST-as-GET Request dieses Geheimniss erfragen. Das Geheimnis kann nur mithilfe des TPM Chips entschlüsselt werden und die so entschlüsselte Nachricht, wird wieder zurück an den Server gesendet. Wurde das Geheimniss korrekt entschlüsselt gilt die Challenge als erfüllt und der Server ändert den Status der Challenge von "pending" über "processing" zu "valid". Durch das Erfüllen der Challenge wird sichergestellt, dass der Client die Kontrolle über den TPM Chip besitzt. Die Prüfung der Identität des Client Geräts ist eine Prüfung der Kontrolle über den entsprechenden TPM Chip.

### CSR
Für die Erstellung des CSR verwendet der Client nun den TPM Chip, da dieser über einen eingebaute kryptographische Funktion verfügt und weil der Private Key nie außerhalb des Chips existieren darf. Der Public Key wird mit anderen Daten, die in der CSR stehen sollen mit dem TPM Chip verschlüsselt. Diese Nachricht wird an den Server gesendet der das Zertifikat erstellt und dem Client zur Verfügung stellt, sodass dieser es per POST-as-GET Request abfragen kann. Das so erhaltene Zertifikat wird nun auf dem TPM Chip gespeichert. Der Schlüssel welcher zur
Erstellung des Zertifikates verwendet wurde ist dabei der gleiche, welcher mit dem EK AK Verfahren überprüft wurde. Es handelt sich um den öffentlichen sowie dem privaten Teil des AK.

### Folge Anfragen
Der Client hat nun dem Server gegenüber bewiesen, dass dieser tatsächlich die Kontrolle über den TPM Chip, welchen er angegeben hat, besitzt. Diese Information ist jedoch nur solange gültig, wie das Zertifikat gültig ist. Möchte der Client ein neues Zertifikat beantragen so muss er einen neuen AK Wert generieren, welcher den gleichen Prozess durchläuft wie der erste AK beim ersten mal als eine Order erstellt wurde. Er muss dem Server gegenüber noch einmal beweisen, dass er die Kontrolle über diesen Chip besitzt. Dieses Vorgehen wird so im RFC8555 Dokument festgehalten.
Zu diesem Verfahren gibt es eine Alternative die auch kurz besprochen werden soll. Dabei wird zur Validierung des Clients beim erstellen einer neuen Order, das alte Zertifikat verknüpft, welches den Client bereits validiert hat. Es handelt sich dabei um die Verkettung von Zertifikaten[@chain-of-trust]. Durch die Verknüpfung der Anfrage auf ein neues Zertifikat mit dem alten Zertifikat bewiesen dass der Client die Kontrolle über den Chip immer noch besitzt.

## Zusätzliche Maßnahmen
### Clientseitig
Der Client verfügt also über die Möglichkeit unter Verwendung des TPM Chips ein Zertifikat vom spezifizierten ACME Server zu erhalten. Das gesamte Verfahren wäre nutzlos wenn es für einen Benutzer des Client Geräts möglich wäre wertvolle Informationen aus dem Ablauf des neuen ACME Requests abzufangen. Es soll also eine zusätzliche Sicherheit geschaffen werden um das Client Gerät vor seinen eigenen Nutzern zu schützen. Eine dem entsprechende Maßnahme ist, dass der Private Key welcher zum Zertifikat gehört den TPM nie verlässt. Aber auch Metadaten könnten für einen Angreifer interessant sein. Neben Böswilligen kann es auch fahrlässige Nutzer geben die schlicht vergessen ein Zertifikat anzufragen oder zu erneuern falls es veraltet. Aus all diesen Gründen wird ein System Daemon geschaffen, der die clientseitige Kommunikation mit dem ACME Server übernimmt. Dabei soll geprüft werden ob, ein Zertifikat vorhanden ist. Falls nein wird ein neues erstellt. Ist ein Zertifikat vorhanden, aber veraltet, oder läuft bald aus, so wird ein neues Zertifikat angefragt. Dadurch läuft die Kommunikation im Hintergrund ab und ist für den Nutzer des Gerätes unsichtbar. Zertifikate werden dem Nutzer nur durch den TPM Chip zur Verfügung gestellt.

### Serverseitig
Der ACME Server wird um die Funktionalität der Datenbank sowie der Bearbeitung der Challenge erweitert. Dabei soll es einem Systemadministrator einfach gemacht werden die Liste der bekannten EK Public Keys zu erweitern. Auch Serverseitig gibt es Möglichkeiten wie der Umgang mit EK Werten sicherer gestaltet werden kann. So ist es möglich, sobald ein Client eine "ek" Challenge gestellt und bestanden hat, dessen Account mit dem entsprechendem EK Wert in der Datenbank zu verknüpfen. So kann immer eindeutig identifiziert werden, wenn ein neues Zertifikat erstellt wird für welchen TPM dieses gilt. So ist es auch einfacher Zertifikate zu widerrufen, sollte das Gerät als gestohlen oder vermisst gemeldet werden, da nun diesem Datenbank Eintrag, mit all seinen verknüpften Informationen nicht mehr vertraut werden kann.
